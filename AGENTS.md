# AGENTS.md

## 目次

- 概要
- 目的と目標
- 適用範囲
- エージェント分類と役割
- 運用原則
- 利用ワークフロー
- コード変更ポリシー
- テストとCI要件
- ドキュメントと履歴管理
- セキュリティと機密情報
- 監査・ログと可視化
- 責任分担と連絡先
- フォルダ構成と責務
- 設計方針
- テンプレートと実例
- FAQ
- 付録（ツール／スクリプト）

## 概要

このドキュメントは `locale_sheet` リポジトリにおけるAIエージェントおよび自動化ツールの利用方針、運用手順、責任分担を定義します。
対象読者: 開発者、レビュー担当、CI運用者、プロジェクトオーナー。

## 目的と目標

- 開発速度と品質の向上（繰り返し作業の自動化）
- 可監査・再現可能な変更フローの確立
- テストカバレッジとメンテナンス性の維持/向上

## 適用範囲

- 自動化を許可するタスク例: リファクタ提案、定型テスト追加、コード整形、ドキュメント生成、簡易なバグ修正（明確なユニットテストがある場合）。
- 自動化を禁止/制限するケース: セキュリティ関連の変更、認証/認可ロジック、秘密情報の取り扱い、重大な設計変更。これらは必ず人の承認とレビューを要する。

## エージェント分類と役割

- コーディングエージェント: 小さな修正やテスト追加を自動で作成する。出力はパッチ（diff）形式で記録。
- CI/テスト自動化: カバレッジ収集、テストの実行、失敗時の通知。
- ドキュメント自動生成: README、CHANGELOG、APIサマリなどの下書きを作る。
- リリース支援: バージョン更新、アセット生成（手動承認が必要）。

## 運用原則

- 最小権限: 自動化された処理は必要最小限の権限で実行する（CIのトークン、デプロイ権限など）。
- 可監査性: すべての自動実行はログと差分（patch）を残す。
- 人間による最終レビュー: 重要な変更は必ず人がレビューする。自動マージは原則禁止。
- 再現性: スクリプト・コマンドはバージョン管理下に置く（`scripts/`）。

## 利用ワークフロー

1. 要求作成: 変更要求（テンプレート参照）を作成。
2. 自動実行（オプション）: エージェントが提案パッチを作成し、CIを走らせる。
3. 検証: テストとカバレッジ結果を確認。
4. レビュー: レビュワーが差分を点検し承認。
5. マージ/デプロイ: 承認後に人がマージ。自動デプロイは事前承認されたジョブのみ実行。
6. 履歴記録: 変更理由・ログを本書に追記（サマリ）またはPRに記載。

## コード変更ポリシー

- 変更はパッチ（diff）形式で提出すること。
- 変更を自動で適用する場合でも、少なくとも1名の人間によるレビューと承認を必須とする。
- apply_patch の利用例やコミットメッセージ規約:
  - コミットタイトル: `<scope>: <短い要約>` 例: `core: improve parser error handling`
  - 本文には「なぜ」であり「何を」を簡潔に記載。
- エージェントがソースコードを変更した場合、変更点を1項目ごとに説明すること。各項目に含める情報:
  - **変更内容**: 変更されたファイル・関数・行の要約
  - **理由**: なぜこの変更が必要か（不具合、リファクタ、性能改善等）
  - **差分/パッチへの参照**: PR番号またはパッチファイルへのリンク
  - **テスト**: 追加・修正したテスト（テスト名）と実行手順
  - **リスク/後続作業**: 既知の影響、必要な追加作業や注意点

  この項目別説明はPR本文または実行ログに必ず含めること（監査・ログ参照）。

- ソースコードを変更する場合の必須手順（エージェント・人間問わず）:
  - **テスト実行**: すべてのテストを実行し、失敗があれば原因を解消すること。
  - **静的解析**: `dart analyze` 等の静的解析を実行し、エラーや警告があれば解消すること。
  - **カバレッジ確認**: カバレッジを測定し、プロジェクトの閾値を満たさない場合は必要なテストコードを追加すること。
  これらはPRに実行結果の要約（失敗があれば修正内容）を含めること。

## テストとCI要件

- テストコード: ソースコードとテストコードのファイルは1:1で作成すること。
- テスト配置: `lib/src/...` に対応する `test/...` を用意すること。
- カバレッジ: 目標はモジュール単位での高いカバレッジ（プロジェクト固有の閾値はチーム合意で設定）。
- CI ルール: 重要なブランチへのマージはすべてCI通過が必須。テスト失敗・カバレッジ低下はマージブロッカーとする。
- すべてのテストコードはAAAパターン（Arrange-Act-Assert）で記述する
  - テスト関数毎に`// Arrange`、`// Act`、`// Assert`を記載すること
- 各テストケースには「テストの意図」を日本語のドキュメンテーションコメント（///）で明記する

## ドキュメントと履歴管理

- 外部仕様（API 仕様、公開仕様、フォーマット等）が変更になる場合は、関連するドキュメントを更新すること。具体的には `README.md` と `README_ja.md` の両方を見直し、変更点と互換性への影響を明記すること。
- プルリクエスト（PR）作成時には、該当する変更を `CHANGELOG.md` に追記すること（草案可）。PR 本文に CHANGELOG の該当エントリを含め、レビューで確認できる状態にすること。
- `CHANGELOG.md` に記載するバージョンおよび日付は、実際に `pub.dev` へ publish するタイミングで確定する。プルリク作成時点ではプレースホルダとして次の形式を記載すること: `vx.x.x 20xx-xx-xx`。

## セキュリティと機密情報

- シークレットはソースツリーに含めない。CI シークレット管理を利用すること。
- 外部APIキーや機密データに触れる操作は手動承認が必要。

## 監査・ログと可視化

- 自動実行は以下を必ず出力すること: 実行者（エージェント名/ジョブID）、実行日時、生成パッチ、テスト結果の要約。
- ログはアーカイブ形式で保存し、必要に応じて検索可能にする。

## 責任分担と連絡先

- 所有者（Owner）: プロジェクトの最終決定権を持つ人物（1名）。
- レビュワー: 自動化提案をレビューする担当者（複数可）。
- 緊急連絡: セキュリティ/破壊的変更は即時エスカレーションルートを用意する。

## フォルダ構成と責務

- `bin/`: CLI エントリポイント（`bin/locale_sheet.dart`）。実行可能コードのみを置く。
- `lib/`: ライブラリ本体
  - `lib/locale_sheet.dart`: 公開 API
  - `lib/src/core/`: ドメインモデル、パーサ、ビジネスロジック（`model.dart`, `parser.dart`, `localization_*` 等）。コアロジックは原則副作用を避ける。
  - `lib/src/cli/`: CLI 層（入力パース、引数処理、ログ出力）。CLI はコアを呼び出す薄いアダプタに留める。
  - `lib/src/exporters/`: 出力フォーマット変換器（ARB 等）。エクスポーターは入出力変換に専念し、ビジネスロジックを含めない。
- `test/`: ユニット・統合テスト。`lib/src/` のモジュール構成に対応したサブディレクトリを配置する（1:1 テスト配置）。
- `scripts/`: CI 用スクリプト・ユーティリティ（`coverage.sh`, `clean.sh`）。環境依存処理を含める場合は OS 別スクリプトを用意する。
- `example/`: 使用例やサンプルコード。
- `doc/`, `tool/`: 補助ツール・ドキュメント。

## 設計方針

- 単一責務: 各モジュール/クラスは一つの責務に集中させる。
- ドメインとインフラの分離: ビジネスロジックは `core/` に、IO/CLI/エクスポートはそれ以外に分離する。
- 依存性注入: テスト容易性のために外部依存は注入可能にする（グローバル状態を避ける）。
- 純関数優先: 副作用を伴う処理は明示的に分離し、コアロジックは可能な限り純関数とする。
- エラーハンドリング: 失敗は明示的に扱い、ユーザーへはわかりやすいメッセージとログを出す。
- ロギング: `lib/src/cli/logger.dart` 等の統一されたロガーを使い、デバッグ時に十分な情報を出す。
- API の安定性: 外部仕様を変更する際は互換性と移行手順を文書化する（`README.md`/`README_ja.md` 更新必須）。
- テストファースト: 変更はテストで保護し、必須テストカバレッジを維持する。
- ドキュメント: 公開 API と重要な設計判断はコード内コメントとリポジトリドキュメントに残す。

## テンプレートと実例

### 変更要求テンプレート

```ai
タイトル: <短い要約>
背景/目的: <なぜこの変更が必要か>
提案内容: <何を変更するか（要点）>
テスト: <追加/修正するテストと検証手順>
リスク/注意点: <既知の影響範囲>
```

### パッチ提出の例

- 自動エージェントは PR に patch を添付し、PR 本文に生成手順と実行ログを残すこと。

## FAQ

- Q: エージェントが作った変更を自動でマージできますか？
- A: 原則できません。重要度が低く明示的に許可された変更のみ、事前に設定された自動マージポリシーの下で可能です。

## 付録（ツール／スクリプト）

### Mac/Linux

- カバレッジ取得: `make coverage`
- クリーン: `make clean`
- フォーマット: `make format`
- カバレッジ+フォーマット+静的解析: `make verify`

### Windows

- カバレッジ取得: `make.ps1 coverage`
- クリーン: `make.ps1 clean`
- フォーマット: `make.ps1 format`
- カバレッジ+フォーマット+静的解析: `make.ps1 verify`
